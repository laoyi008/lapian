# 更新日志 - 字幕功能

## 版本 v2.3 - 2025-12-03

### 🎉 新增功能

#### 字幕内容显示

在视频分镜拆解分析结果中，现在会显示每个镜头对应的字幕内容。

**功能特点：**
- ✅ 自动识别视频中的语音内容
- ✅ 按时间轴匹配到对应镜头
- ✅ 在分析表格中单独显示字幕列
- ✅ 无字幕时显示"-"

---

## 📝 详细变更

### 1. 类型定义更新

**文件：** `src/types/video.ts`

**变更：** 在 `ShotAnalysis` 接口中添加 `subtitle` 字段

```typescript
export interface ShotAnalysis {
  // ... 其他字段
  subtitle?: string; // 新增：该镜头的字幕/语音内容
}
```

**影响：** 所有使用 `ShotAnalysis` 类型的地方现在都支持字幕字段

---

### 2. 数据采集更新

**文件：** `src/pages/Home.tsx`

**变更：** 在创建分析对象时保存字幕内容

```typescript
const analysis: ShotAnalysis = {
  // ... 其他字段
  subtitle: audioForThisShot || '' // 新增：保存该镜头的字幕内容
};
```

**影响：** 每个镜头的分析结果现在包含对应的字幕内容

---

### 3. 表格展示更新

**文件：** `src/pages/Home.tsx`

**变更：** 在Markdown表格中添加字幕列

**修改前：**
```typescript
overallDescription += `| 镜号 | 画面截图 | 景别/角度 | 运动方式 | 画面内容 | 时长(秒) |\n`;
overallDescription += `|------|----------|-----------|----------|----------|----------|\n`;
```

**修改后：**
```typescript
overallDescription += `| 镜号 | 画面截图 | 景别/角度 | 运动方式 | 画面内容 | 字幕内容 | 时长(秒) |\n`;
overallDescription += `|------|----------|-----------|----------|----------|----------|----------|\n`;
```

**影响：** 分析报告表格现在包含字幕内容列

---

### 4. 字幕数据处理

**文件：** `src/pages/Home.tsx`

**变更：** 处理字幕内容的特殊字符

```typescript
const subtitle = a.subtitle ? a.subtitle.replace(/\|/g, '\\|') : '-';
overallDescription += `| ${shotNum} | ${imageRef} | ${shotTypeAngle} | ${movement} | ${content} | ${subtitle} | ${dur} |\n`;
```

**影响：** 
- 有字幕时显示实际内容
- 无字幕时显示"-"
- 自动转义Markdown表格中的特殊字符

---

## 🎯 功能对比

### 修改前

| 镜号 | 画面截图 | 景别/角度 | 运动方式 | 画面内容 | 时长(秒) |
|------|----------|-----------|----------|----------|----------|
| 1 | ![镜头1](...) | 中景/平视 | 固定镜头 | 主持人介绍产品 | 3.5 |

**问题：** 无法看到人物说话的内容

### 修改后

| 镜号 | 画面截图 | 景别/角度 | 运动方式 | 画面内容 | **字幕内容** | 时长(秒) |
|------|----------|-----------|----------|----------|------------|----------|
| 1 | ![镜头1](...) | 中景/平视 | 固定镜头 | 主持人介绍产品 | **大家好，欢迎观看** | 3.5 |

**改进：** 可以清楚看到每个镜头对应的字幕内容

---

## 📊 技术细节

### 字幕匹配逻辑

```typescript
// 1. 音频识别结果按时间存储
audioTranscriptByTime = {
  0: "第一段字幕",
  60: "第二段字幕",
  120: "第三段字幕"
}

// 2. 为每个镜头匹配对应时间段的字幕
const audioForThisShot = Object.keys(audioTranscriptByTime)
  .map(Number)
  .filter(time => time >= frame.timestamp && (!nextFrame || time < nextFrame.timestamp))
  .map(time => audioTranscriptByTime[time])
  .join(' ');

// 3. 保存到分析结果
analysis.subtitle = audioForThisShot || '';
```

### 表格渲染逻辑

```typescript
// 1. 获取字幕内容
const subtitle = a.subtitle ? a.subtitle.replace(/\|/g, '\\|') : '-';

// 2. 添加到表格行
overallDescription += `| ${shotNum} | ${imageRef} | ${shotTypeAngle} | ${movement} | ${content} | ${subtitle} | ${dur} |\n`;
```

---

## 🧪 测试验证

### 测试场景1：有字幕的视频

**输入：** 产品介绍视频，主持人讲解

**预期输出：**
- ✅ 每个镜头显示对应的讲解内容
- ✅ 字幕内容清晰可读
- ✅ 时间匹配准确

### 测试场景2：部分有字幕的视频

**输入：** 风景视频，部分有解说

**预期输出：**
- ✅ 有解说的镜头显示字幕
- ✅ 无解说的镜头显示"-"
- ✅ 不影响整体分析

### 测试场景3：无字幕的视频

**输入：** 纯音乐MV，无人声

**预期输出：**
- ✅ 所有镜头字幕列显示"-"
- ✅ 其他分析功能正常
- ✅ 表格格式正确

---

## 💡 使用建议

### 1. 视频要求

- ✅ 音频清晰，无过多噪音
- ✅ 语速适中，发音清晰
- ✅ 使用标准普通话
- ✅ 避免多人同时说话

### 2. 最佳实践

- 上传高质量音频的视频
- 检查字幕识别准确性
- 必要时可手动修正
- 导出后可进一步编辑

### 3. 注意事项

- 方言识别可能不准确
- 背景音乐会影响识别
- 长字幕会自动换行
- 特殊字符会自动转义

---

## 🔄 兼容性

### 向后兼容

- ✅ 旧版本分析结果仍可查看
- ✅ 不影响现有功能
- ✅ 平滑升级，无需迁移

### 数据兼容

- ✅ 新字段为可选字段
- ✅ 旧数据自动显示"-"
- ✅ 不破坏现有数据结构

---

## 📈 性能影响

### 分析时间

- 音频识别：+10-30秒（取决于视频长度）
- 字幕匹配：<1秒
- 表格生成：<1秒
- **总体影响：** 轻微增加，可接受

### 内存占用

- 字幕数据：+1-5KB（每个镜头）
- **总体影响：** 可忽略

### 网络流量

- API调用：已有功能，无额外增加
- **总体影响：** 无

---

## 🐛 已知问题

### 1. 识别准确性

**问题：** 方言、口音可能识别不准确

**解决方案：** 使用标准普通话，或后期手动修正

### 2. 长字幕显示

**问题：** 过长字幕在表格中可能影响阅读

**解决方案：** 建议视频字幕简洁明了

### 3. 背景噪音

**问题：** 背景音乐或噪音影响识别

**解决方案：** 使用音频清晰的视频

---

## 🚀 未来计划

### 短期（v2.4）

- [ ] 支持字幕编辑功能
- [ ] 支持导出SRT字幕文件
- [ ] 优化长字幕显示

### 中期（v2.5）

- [ ] 支持多语言识别
- [ ] 支持字幕时间轴调整
- [ ] 支持字幕关键词高亮

### 长期（v3.0）

- [ ] 支持字幕情感分析
- [ ] 支持字幕自动摘要
- [ ] 支持字幕翻译功能

---

## 📚 相关文档

- [SUBTITLE_FEATURE.md](SUBTITLE_FEATURE.md) - 字幕功能详细说明
- [USER_GUIDE.md](USER_GUIDE.md) - 用户使用指南
- [API_DOCUMENTATION.md](API_DOCUMENTATION.md) - API文档

---

## ✅ 变更检查清单

- [x] 类型定义更新
- [x] 数据采集更新
- [x] 表格展示更新
- [x] 特殊字符处理
- [x] 代码lint检查
- [x] 功能文档编写
- [x] 更新日志编写
- [ ] 用户测试验证

---

## 📞 反馈

如有问题或建议，请：

1. 查看 [SUBTITLE_FEATURE.md](SUBTITLE_FEATURE.md) 了解详细功能
2. 查看 [TROUBLESHOOTING.md](TROUBLESHOOTING.md) 排查问题
3. 提供详细的反馈信息

---

**版本：** v2.3  
**发布日期：** 2025-12-03  
**状态：** ✅ 已发布  
**测试状态：** ⏳ 待用户验证

---

## 🎉 总结

本次更新为视频分镜拆解分析功能添加了字幕内容显示，使分析结果更加完整和实用。用户现在可以同时看到画面内容和对应的字幕内容，便于全面分析视频。

**核心改进：**
- ✅ 新增字幕列显示
- ✅ 自动匹配时间轴
- ✅ 智能处理无字幕情况
- ✅ 保持向后兼容

**用户价值：**
- 📊 更完整的分析结果
- 🎯 更准确的内容理解
- 💡 更便捷的创作参考
- 🚀 更高效的工作流程
