# 卡密系统功能说明

## 功能概述

本次更新为短视频拉片分析工具添加了完整的卡密系统，包括：

1. **用户端**：在积分充值页面添加卡密兑换功能
2. **管理端**：在管理后台添加卡密生成和管理功能

## 数据库变更

### 新增表：card_codes

```sql
- id: uuid (主键)
- code: text (卡密码，唯一)
- points: integer (积分数量)
- status: text (状态：unused/used)
- created_by: uuid (创建者ID)
- used_by: uuid (使用者ID，可为空)
- used_at: timestamptz (使用时间，可为空)
- created_at: timestamptz (创建时间)
```

### 新增RPC函数：redeem_card_code

用于处理卡密兑换逻辑，包括：
- 验证卡密有效性
- 更新卡密状态
- 增加用户积分
- 记录积分交易

## 功能详情

### 1. 用户端 - 卡密兑换

**位置**：积分充值页面 (`/recharge`)

**功能**：
- 新增"卡密兑换"标签页
- 用户可以输入卡密码进行兑换
- 卡密格式：XXXX-XXXX-XXXX-XXXX（16位字符，不区分大小写）
- 兑换成功后积分立即到账
- 显示使用说明和获取卡密的方式

**使用流程**：
1. 进入积分充值页面
2. 切换到"卡密兑换"标签
3. 输入卡密码
4. 点击"立即兑换"按钮
5. 系统验证卡密并增加积分

### 2. 管理端 - 卡密管理

**位置**：管理后台 (`/admin`)

**功能**：
- 新增"卡密管理"标签页
- 显示卡密统计信息（总数、未使用、已使用、积分价值等）
- 批量生成卡密（可指定积分数量和生成数量）
- 查看所有卡密列表
- 复制卡密码
- 查看卡密使用情况

**使用流程**：
1. 以管理员身份登录
2. 进入管理后台
3. 切换到"卡密管理"标签
4. 输入积分数量和生成数量
5. 点击"生成卡密"按钮
6. 在卡密列表中查看和复制生成的卡密

## 安全策略

### RLS（行级安全）策略

1. **管理员权限**：
   - 可以查看所有卡密
   - 可以创建新卡密

2. **普通用户权限**：
   - 只能查看自己使用过的卡密
   - 不能创建卡密

### 卡密生成规则

- 使用大写字母和数字（排除易混淆字符：I, O, 0, 1）
- 格式：XXXX-XXXX-XXXX-XXXX
- 每个卡密唯一，不可重复使用

## API函数

### 前端API（@/db/api.ts）

1. `createCardCode(points: number)` - 创建单个卡密
2. `createCardCodesBatch(points: number, count: number)` - 批量创建卡密
3. `getAllCardCodes(limit: number)` - 获取所有卡密列表
4. `getUserUsedCardCodes(userId: string)` - 获取用户使用过的卡密
5. `redeemCardCode(code: string)` - 兑换卡密
6. `getCardCodeStats()` - 获取卡密统计信息

## 测试建议

### 管理员测试

1. 登录管理员账号
2. 进入管理后台 -> 卡密管理
3. 生成测试卡密（例如：1000积分，数量1）
4. 复制生成的卡密码

### 用户测试

1. 登录普通用户账号（或注册新账号）
2. 进入积分充值页面
3. 切换到"卡密兑换"标签
4. 输入刚才复制的卡密码
5. 点击"立即兑换"
6. 验证积分是否正确增加

### 验证点

- ✅ 卡密只能使用一次
- ✅ 已使用的卡密无法再次兑换
- ✅ 兑换成功后积分立即到账
- ✅ 管理员可以看到卡密的使用情况
- ✅ 普通用户只能看到自己使用过的卡密

## 注意事项

1. 卡密生成数量限制为1-100个
2. 卡密码不区分大小写
3. 每个卡密只能使用一次
4. 兑换成功后会在积分交易记录中显示
5. 管理员可以查看所有卡密的创建者和使用者信息
