# 🔍 字幕显示调试指南

## 📋 问题描述

视频拉片分析时，字幕内容列显示为空白，但视频实际有人声内容。

---

## 🎯 调试步骤

### 第1步：打开浏览器控制台

1. 按 `F12` 键打开开发者工具
2. 切换到 **Console（控制台）** 标签
3. 清空之前的日志（点击🚫图标）

### 第2步：上传视频并开始分析

1. 选择一个包含人声的视频文件
2. 点击"开始分析"按钮
3. 观察控制台输出

### 第3步：查看音频识别日志

在控制台中查找以下关键日志：

#### 3.1 音频分析开始

```
=== 开始音频分析 ===
视频时长: 10.5 秒
视频文件大小: 1234567 字节
```

#### 3.2 音频解码

```
正在解码音频数据...
✅ 音频解码成功！
- 音频时长: 10.5 秒
- 采样率: 48000 Hz
- 声道数: 2
```

**如果看到：**
```
❌ 视频没有音频轨道或音频解析失败
```
**说明：** 视频文件没有音频轨道或音频格式不支持

#### 3.3 音频提取和分割

```
正在提取音频，目标时长: 10.5 秒
✅ 音频提取完成！
- WAV文件大小: 1008044 字节
- WAV文件类型: audio/wav

正在分割音频，每段60秒...
✅ 音频分割完成，共 1 段
  - 第 1 段: 1008044 字节
```

#### 3.4 语音识别

```
开始识别所有音频段...

--- 识别第 1/1 段音频 ---
音频块大小: 1008044 字节
Base64编码长度: 1344060 字符
调用语音识别API...
API响应: {
  "status": 0,
  "msg": "success",
  "data": {
    "err_no": 0,
    "err_msg": "success.",
    "result": ["大家好，今天给大家介绍一款新产品"]
  }
}
✅ 识别成功: 大家好，今天给大家介绍一款新产品
保存字幕: 时间=0秒, 内容="大家好，今天给大家介绍一款新产品"
```

**关键检查点：**
- `err_no` 应该为 `0`
- `result` 数组应该包含识别出的文字
- 应该看到"✅ 识别成功"

**如果看到：**
```
❌ 识别失败: speech quality problem (err_no: 3301)
```
**说明：** 音频质量问题，可能是：
- 视频中没有人声（纯音乐）
- 音量太小
- 背景噪音太大

#### 3.5 音频识别完成

```
=== 音频识别完成 ===
识别出的字幕段数: 3
字幕内容: {
  "0": "大家好，今天给大家介绍一款新产品",
  "5": "这款产品采用了最新的技术",
  "8": "使用起来非常简单方便"
}
```

**关键检查：**
- `识别出的字幕段数` 应该 > 0
- `字幕内容` 对象应该包含时间戳和文字

### 第4步：查看字幕匹配日志

在控制台中查找镜头分析日志：

```
=== 正在分析第 1/3 个镜头 ===
镜头时间戳: 0秒
镜头时长: 5.00秒
下一个镜头时间戳: 5秒

查找字幕时间范围: 0秒 - 5秒
可用的字幕时间点: [0, 5, 8]
匹配到的字幕时间点: [0]
第 1 个镜头的字幕内容: 大家好，今天给大家介绍一款新产品
字幕长度: 18 字符
```

**关键检查：**
- `可用的字幕时间点` 应该显示所有识别出的字幕时间
- `匹配到的字幕时间点` 应该显示该镜头范围内的时间点
- `字幕内容` 应该显示具体的文字

**如果看到：**
```
匹配到的字幕时间点: []
第 1 个镜头的字幕内容: 【无字幕】
```
**说明：** 该镜头的时间范围内没有匹配到字幕

### 第5步：查看镜头数据保存日志

```
✅ 第 1 个镜头分析数据已保存:
- 景别: 中景
- 角度: 平视
- 运动: 固定镜头
- 时长: 5.0秒
- 字幕: "大家好，今天给大家介绍一款新产品"
- 字幕长度: 18 字符
```

**关键检查：**
- `字幕` 字段应该包含文字内容
- `字幕长度` 应该 > 0

### 第6步：查看页面显示

#### 6.1 音频识别调试信息卡片

在分析完成后，页面上应该显示"音频识别调试信息"卡片：

```
音频识别调试信息
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
音频识别完成：
识别出 3 段字幕

字幕内容：
0秒: 大家好，今天给大家介绍一款新产品
5秒: 这款产品采用了最新的技术
8秒: 使用起来非常简单方便
```

**如果没有显示这个卡片：**
- 说明音频识别失败或没有识别到内容

#### 6.2 视频分镜拆解分析表格

在"视频分镜拆解分析"表格中，查看"字幕内容"列：

| 镜号 | 画面截图 | 景别/角度 | 运动方式 | 画面内容 | 字幕内容 | 时长 |
|------|----------|-----------|----------|----------|----------|------|
| 1 | [图片] | 中景/平视 | 固定镜头 | ... | 💬 大家好，今天给大家介绍一款新产品 | 5.0秒 |
| 2 | [图片] | 特写/平视 | 推镜头 | ... | 💬 这款产品采用了最新的技术 | 3.0秒 |
| 3 | [图片] | 中景/平视 | 固定镜头 | ... | 💬 使用起来非常简单方便 | 2.5秒 |

**如果字幕内容列显示"-"：**
- 说明该镜头没有匹配到字幕
- 检查控制台日志，查看字幕匹配情况

#### 6.3 统计信息

查看表格下方的统计信息：

```
┌──────────┬──────────┬──────────┬──────────┐
│ 总镜头数 │  总时长  │ 平均时长 │有字幕镜头│
│    3     │ 10.5秒   │  3.5秒   │    3     │
└──────────┴──────────┴──────────┴──────────┘
```

**关键检查：**
- `有字幕镜头` 应该 > 0

---

## 🐛 常见问题排查

### 问题1：音频识别完成，但字幕内容列为空

**可能原因：**
1. 字幕时间戳与镜头时间戳不匹配
2. 字幕数据没有正确传递到显示组件

**排查步骤：**

1. **检查字幕时间戳**
   ```
   可用的字幕时间点: [0, 5, 8]
   ```
   
2. **检查镜头时间戳**
   ```
   镜头时间戳: 0秒
   下一个镜头时间戳: 5秒
   ```

3. **检查匹配结果**
   ```
   匹配到的字幕时间点: [0]
   ```

4. **检查保存的数据**
   - 在控制台输入：
     ```javascript
     console.log(shotAnalyses)
     ```
   - 查看每个镜头的 `subtitle` 字段

**解决方案：**
- 如果字幕时间戳都在镜头切换点之后，可能需要调整匹配逻辑
- 如果数据保存正确但显示为空，检查组件传参

### 问题2：音频识别失败（err_no: 3301）

**错误信息：**
```
❌ 识别失败: speech quality problem (err_no: 3301)
```

**原因：** 音频质量问题

**可能情况：**
1. 视频是纯音乐，没有人声
2. 人声音量太小
3. 背景噪音太大
4. 音频编码格式问题

**解决方案：**
1. 确认视频确实有清晰的人声
2. 尝试使用音量较大、人声清晰的视频
3. 使用标准的视频格式（MP4、MOV）

### 问题3：音频识别失败（err_no: 3302）

**错误信息：**
```
❌ 识别失败: authentication failed (err_no: 3302)
```

**原因：** API鉴权失败

**解决方案：**
1. 检查 `.env` 文件中的 `VITE_APP_ID`
2. 确认API配置正确
3. 检查网络连接

### 问题4：视频没有音频轨道

**错误信息：**
```
❌ 视频没有音频轨道或音频解析失败
```

**原因：** 视频文件不包含音频轨道

**解决方案：**
1. 使用包含音频的视频文件
2. 检查视频文件是否损坏
3. 尝试使用其他视频播放器确认视频有声音

### 问题5：字幕时间戳不准确

**现象：** 字幕匹配到了错误的镜头

**原因：** 
1. 音频分割时的时间戳计算不准确
2. 镜头切换检测不准确

**排查步骤：**
1. 查看控制台日志中的时间戳
2. 对比实际视频的时间点

**解决方案：**
- 调整音频分割逻辑
- 优化镜头切换检测算法

---

## 📊 完整的调试日志示例

### 成功案例

```
=== 开始音频分析 ===
视频时长: 10.5 秒
视频文件大小: 1234567 字节
视频文件已读取，大小: 1234567 字节
正在解码音频数据...
✅ 音频解码成功！
- 音频时长: 10.5 秒
- 采样率: 48000 Hz
- 声道数: 2
正在提取音频，目标时长: 10.5 秒
✅ 音频提取完成！
- WAV文件大小: 1008044 字节
- WAV文件类型: audio/wav
正在分割音频，每段60秒...
✅ 音频分割完成，共 1 段
  - 第 1 段: 1008044 字节
开始识别所有音频段...

--- 识别第 1/1 段音频 ---
音频块大小: 1008044 字节
Base64编码长度: 1344060 字符
调用语音识别API...
API响应: {
  "status": 0,
  "msg": "success",
  "data": {
    "corpus_no": "7368634167330515968",
    "err_no": 0,
    "err_msg": "success.",
    "sn": "123456789",
    "result": ["大家好，今天给大家介绍一款新产品，这款产品采用了最新的技术，使用起来非常简单方便"]
  }
}
✅ 识别成功: 大家好，今天给大家介绍一款新产品，这款产品采用了最新的技术，使用起来非常简单方便
保存字幕: 时间=0秒, 内容="大家好，今天给大家介绍一款新产品，这款产品采用了最新的技术，使用起来非常简单方便"

=== 音频识别完成 ===
识别出的字幕段数: 1
字幕内容: {
  "0": "大家好，今天给大家介绍一款新产品，这款产品采用了最新的技术，使用起来非常简单方便"
}

开始分析 3 个镜头

=== 正在分析第 1/3 个镜头 ===
镜头时间戳: 0秒
镜头时长: 5.00秒
下一个镜头时间戳: 5秒

查找字幕时间范围: 0秒 - 5秒
可用的字幕时间点: [0]
匹配到的字幕时间点: [0]
第 1 个镜头的字幕内容: 大家好，今天给大家介绍一款新产品，这款产品采用了最新的技术，使用起来非常简单方便
字幕长度: 44 字符

✅ 第 1 个镜头分析数据已保存:
- 景别: 中景
- 角度: 平视
- 运动: 固定镜头
- 时长: 5.0秒
- 字幕: "大家好，今天给大家介绍一款新产品，这款产品采用了最新的技术，使用起来非常简单方便"
- 字幕长度: 44 字符

=== 正在分析第 2/3 个镜头 ===
镜头时间戳: 5秒
镜头时长: 3.00秒
下一个镜头时间戳: 8秒

查找字幕时间范围: 5秒 - 8秒
可用的字幕时间点: [0]
匹配到的字幕时间点: []
第 2 个镜头的字幕内容: 【无字幕】

✅ 第 2 个镜头分析数据已保存:
- 景别: 特写
- 角度: 平视
- 运动: 推镜头
- 时长: 3.0秒
- 字幕: 【无】
- 字幕长度: 0 字符

=== 正在分析第 3/3 个镜头 ===
镜头时间戳: 8秒
镜头时长: 2.50秒
下一个镜头时间戳: 无（最后一个镜头）秒

查找字幕时间范围: 8秒 - 10.5秒
可用的字幕时间点: [0]
匹配到的字幕时间点: []
第 3 个镜头的字幕内容: 【无字幕】

✅ 第 3 个镜头分析数据已保存:
- 景别: 中景
- 角度: 平视
- 运动: 固定镜头
- 时长: 2.5秒
- 字幕: 【无】
- 字幕长度: 0 字符
```

**分析：**
- 音频识别成功，识别出1段字幕
- 字幕时间戳为0秒
- 第1个镜头（0-5秒）匹配到字幕
- 第2、3个镜头（5-10.5秒）没有匹配到字幕
- 这是正常的，因为所有人声都在视频开头

---

## ✅ 验证清单

使用此清单验证字幕功能是否正常：

### 音频识别阶段

- [ ] 控制台显示"=== 开始音频分析 ==="
- [ ] 控制台显示"✅ 音频解码成功！"
- [ ] 控制台显示"✅ 音频提取完成！"
- [ ] 控制台显示"✅ 音频分割完成"
- [ ] 控制台显示"✅ 识别成功"
- [ ] 控制台显示"识别出的字幕段数: X"（X > 0）
- [ ] 页面显示toast："✅ 音频识别完成，共识别出 X 段字幕"
- [ ] 页面显示"音频识别调试信息"卡片

### 字幕匹配阶段

- [ ] 控制台显示"可用的字幕时间点"
- [ ] 控制台显示"匹配到的字幕时间点"
- [ ] 控制台显示"第 X 个镜头的字幕内容"
- [ ] 控制台显示"✅ 第 X 个镜头分析数据已保存"
- [ ] 控制台显示"字幕: ..."（有内容）

### 页面显示阶段

- [ ] 页面显示"视频分镜拆解分析"表格
- [ ] 表格包含"字幕内容"列
- [ ] 有字幕的镜头显示💬图标和文字
- [ ] 无字幕的镜头显示"-"
- [ ] 统计信息显示"有字幕镜头"数量 > 0

---

## 🔧 调试技巧

### 技巧1：使用控制台过滤

在控制台中使用过滤功能：

- 过滤音频相关日志：输入 `音频` 或 `识别`
- 过滤字幕相关日志：输入 `字幕` 或 `subtitle`
- 过滤错误日志：输入 `❌` 或 `error`
- 过滤成功日志：输入 `✅` 或 `success`

### 技巧2：检查数据结构

在控制台中输入以下命令：

```javascript
// 查看所有镜头数据
console.table(shotAnalyses)

// 查看每个镜头的字幕
shotAnalyses.forEach((shot, idx) => {
  console.log(`镜头${idx + 1}: ${shot.subtitle || '无字幕'}`)
})

// 查看有字幕的镜头
shotAnalyses.filter(shot => shot.subtitle).forEach((shot, idx) => {
  console.log(`镜头${shot.frameIndex + 1}: ${shot.subtitle}`)
})
```

### 技巧3：导出日志

1. 右键点击控制台
2. 选择"Save as..."
3. 保存日志文件
4. 发送给技术支持

### 技巧4：对比测试

1. 使用已知有人声的视频测试
2. 使用纯音乐视频测试（应该无字幕）
3. 使用无音频视频测试（应该提示无音频）
4. 对比不同视频的日志输出

---

## 📞 获取帮助

如果按照以上步骤仍然无法解决问题，请提供以下信息：

### 必需信息

1. **完整的控制台日志**
   - 从"=== 开始音频分析 ==="开始
   - 到最后的镜头分析完成
   - 保存为文本文件

2. **页面截图**
   - "音频识别调试信息"卡片
   - "视频分镜拆解分析"表格
   - 统计信息区域

3. **视频信息**
   - 视频时长
   - 视频大小
   - 视频格式
   - 是否有人声（播放确认）

4. **错误信息**
   - err_no 值
   - err_msg 内容
   - 完整的错误堆栈

### 可选信息

- 浏览器类型和版本
- 操作系统
- 网络环境
- 视频文件（如果可以分享）

---

## 🎯 预期结果

### 正常情况

1. **音频识别成功**
   - 控制台显示识别出的字幕段数 > 0
   - 页面显示"音频识别调试信息"卡片
   - 卡片中显示所有识别出的字幕

2. **字幕匹配成功**
   - 控制台显示每个镜头匹配到的字幕
   - 镜头数据中包含字幕内容

3. **页面显示正常**
   - 表格"字幕内容"列显示文字
   - 有字幕的镜头显示💬图标
   - 统计信息显示正确的有字幕镜头数

### 异常情况

1. **视频无音频**
   - 控制台显示"视频没有音频轨道"
   - 表格所有镜头的字幕列显示"-"
   - 统计信息显示"有字幕镜头: 0"

2. **音频无人声**
   - 控制台显示"识别出的字幕段数: 0"
   - 页面显示"未识别到语音内容"
   - 表格所有镜头的字幕列显示"-"

3. **部分镜头有字幕**
   - 部分镜头显示字幕内容
   - 部分镜头显示"-"
   - 统计信息显示实际的有字幕镜头数

---

**文档版本：** v1.0  
**创建日期：** 2025-12-03  
**适用版本：** v2.6+  
**状态：** ✅ 可用
