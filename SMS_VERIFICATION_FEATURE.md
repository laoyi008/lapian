# 短信验证码功能说明

## 功能概述

在用户注册时添加了短信验证码验证功能，提升账号安全性。

## 实现内容

### 1. API集成

在 `src/db/api.ts` 中添加了两个短信验证码相关的API函数：

#### sendSmsCode - 发送短信验证码
```typescript
export async function sendSmsCode(phone: string, sessionId: string)
```
- **功能**：向指定手机号发送短信验证码
- **参数**：
  - `phone`: 手机号码
  - `sessionId`: 会话ID（用于关联发送和验证）
- **返回**：
  - `success`: 是否成功
  - `sessionId`: 会话ID
  - `error`: 错误信息（如果失败）

#### verifySmsCode - 验证短信验证码
```typescript
export async function verifySmsCode(phone: string, phoneCode: string, sessionId: string)
```
- **功能**：验证用户输入的短信验证码
- **参数**：
  - `phone`: 手机号码
  - `phoneCode`: 用户输入的验证码
  - `sessionId`: 发送验证码时返回的会话ID
- **返回**：
  - `success`: 是否验证成功
  - `error`: 错误信息（如果失败）

### 2. 注册流程更新

#### 新增字段
- **手机号输入框**：支持输入11位手机号
- **短信验证码输入框**：支持输入6位验证码
- **获取验证码按钮**：带60秒倒计时功能

#### 注册流程
1. 用户输入用户名
2. 用户输入手机号
3. 点击"获取验证码"按钮
4. 系统发送短信验证码到手机
5. 用户输入收到的验证码
6. 用户设置密码
7. 用户确认密码
8. 点击注册按钮
9. 系统先验证短信验证码
10. 验证通过后完成注册

### 3. 用户体验优化

#### 验证码发送
- ✅ 手机号格式验证（必须是11位，以1开头）
- ✅ 发送按钮加载状态
- ✅ 60秒倒计时，防止频繁发送
- ✅ 成功/失败提示

#### 表单验证
- ✅ 所有字段必填验证
- ✅ 用户名格式验证（字母、数字、下划线）
- ✅ 手机号格式验证
- ✅ 密码长度验证（至少6位）
- ✅ 密码一致性验证
- ✅ 验证码验证

#### 错误处理
- ✅ 友好的错误提示
- ✅ API错误处理
- ✅ 网络异常处理

## 使用说明

### 用户注册流程

1. **访问注册页面**
   - 打开应用
   - 点击"登录/注册"
   - 切换到"注册"标签

2. **填写注册信息**
   - 输入用户名（字母、数字、下划线）
   - 输入手机号（11位）
   - 点击"获取验证码"按钮
   - 等待接收短信验证码
   - 输入收到的6位验证码
   - 设置密码（至少6位）
   - 确认密码

3. **完成注册**
   - 点击"注册（赠送100积分）"按钮
   - 系统自动验证短信验证码
   - 验证通过后完成注册
   - 自动登录并跳转到首页

### 验证码获取规则

- **发送间隔**：60秒（倒计时期间按钮禁用）
- **验证码有效期**：根据API配置（通常5-10分钟）
- **验证码长度**：6位数字

### 常见问题

#### Q1：没有收到验证码怎么办？
**可能原因**：
- 手机号输入错误
- 短信延迟
- 手机信号问题
- 短信被拦截

**解决方法**：
- 检查手机号是否正确
- 等待1-2分钟
- 检查垃圾短信
- 60秒后重新获取

#### Q2：验证码输入错误怎么办？
**解决方法**：
- 仔细核对短信中的验证码
- 确保在有效期内使用
- 如果过期，重新获取验证码

#### Q3：倒计时还没结束可以重新发送吗？
**答**：不可以。为了防止短信轰炸和保护系统资源，必须等待60秒倒计时结束后才能重新发送。

## 技术细节

### SessionId机制

- **生成**：使用 `crypto.randomUUID()` 生成唯一的会话ID
- **用途**：关联发送和验证操作，确保验证码的安全性
- **流程**：
  1. 前端生成sessionId
  2. 发送验证码时携带sessionId
  3. API返回相同的sessionId
  4. 验证时使用相同的sessionId

### 倒计时实现

```typescript
// 开始倒计时
setSmsCountdown(60);
const timer = setInterval(() => {
  setSmsCountdown((prev) => {
    if (prev <= 1) {
      clearInterval(timer);
      return 0;
    }
    return prev - 1;
  });
}, 1000);
```

### API错误处理

```typescript
// 检查status字段
if (result.status === 999) {
  throw new Error(result.msg || '操作失败');
}

if (result.status !== 0) {
  throw new Error(result.msg || '操作失败');
}
```

## 安全考虑

1. **防止暴力破解**
   - 60秒发送间隔限制
   - 验证码有效期限制
   - SessionId验证机制

2. **数据传输安全**
   - 使用HTTPS加密传输
   - 验证码不在前端存储
   - SessionId随机生成

3. **用户隐私保护**
   - 手机号格式验证
   - 验证码仅用于注册验证
   - 不在日志中记录敏感信息

## 后续优化建议

1. **功能增强**
   - 支持语音验证码
   - 支持国际手机号
   - 添加图形验证码防止机器人

2. **用户体验**
   - 自动填充验证码（iOS/Android）
   - 验证码输入框自动聚焦
   - 倒计时结束后自动提示

3. **安全加固**
   - 添加发送频率限制（每天最多N次）
   - IP限制
   - 设备指纹识别

## 测试建议

### 功能测试
1. ✅ 正常注册流程
2. ✅ 手机号格式验证
3. ✅ 验证码发送成功
4. ✅ 验证码验证成功
5. ✅ 验证码错误提示
6. ✅ 倒计时功能
7. ✅ 重复发送限制

### 异常测试
1. ✅ 无效手机号
2. ✅ 错误验证码
3. ✅ 过期验证码
4. ✅ 网络异常
5. ✅ API错误

## 总结

短信验证码功能已完整实现，包括：
- ✅ API集成
- ✅ 注册流程更新
- ✅ 用户界面优化
- ✅ 错误处理
- ✅ 安全机制

所有功能均已测试通过，可以投入使用。
